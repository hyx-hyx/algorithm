;filename 8250A.asm
.486
DATA SEGMENT USE16
INPUTBUF DB 125
         DB ?
         DB 125 DUP(?)
RECEIVEBUF DB 125
           DB ?
           DB 125 DUP(?)
DATA ENDS
CODE SEGMENT USE16
    ASSUME CS:CODE,DS:DATA
BEG: MOV AX,DATA
MOV DS,AX

CALL READ
CALL I8250
MOV DL,0DH
MOV AH,02H
INT 21H
MOV DL,0AH
MOV AH,02H
INT 21H
CALL SEND

MOV AX,4CH
INT 21H


READ PROC
MOV DX,OFFSET INPUTBUF
MOV AH,0AH
INT 21H
RET
READ ENDP


SEND PROC
MOV BX,OFFSET INPUTBUF
MOV CH,0
MOV CL,[BX+1]
SCANSEND:
    MOV DX,3FDH
    IN AL,DX
    TEST AL,00011110B
    JNZ ERRSEND
    TEST AL,01H
    JNZ RECV
    TEST AL,20H
    JNZ SENDCHAR
    JMP SCANSEND

SENDCHAR:
    MOV DX,3F8H
    MOV AL,[BX+2]
    OUT DX,AL
    INC BX
    LOOP SCANSEND
    RET

RECV:    
    MOV DX,3F8H
    IN  AL,DX
    MOV DL,AL
    JMP SHOW

ERRSEND:
    RET

SEND ENDP


I8250 PROC
MOV DX,3FBH
MOV AL,80H
OUT DX,AL      ;设置寻址位为1，访问除数寄存器

MOV DX,3F9H
MOV AL,00H
OUT DX,AL
MOV DX,3F8H
MOV AL,0CH
OUT DX,AL      ;设置通信速率为9600波特，除数寄存器为000CH

MOV DX,3FBH
MOV AL,03H
OUT DX,AL       ;规定一帧数据的格式

MOV DX,3F9H
MOV AL,0
OUT DX,AL       ;采用查询方式，设置中断允许控制字为全0

MOV DX,3FCH
MOV AL,10H
OUT DX,AL       ;设置MODEM寄存器，工作方式为内环自检
RET
I8250 ENDP


RECEIVE PROC
    MOV SI,OFFSET RECEIVEBUF
ERRRECV:
    RET
RECEIVE ENDP


SHOW:
MOV AH,02H
INT 21H
JNC SCANSEND


CODE ENDS
    END BEG
